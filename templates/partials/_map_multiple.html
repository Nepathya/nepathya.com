{% load staticfiles %}

<script type="text/javascript" src='http://maps.google.com/maps/api/js?libraries=places'></script>

<div id="map-container" style="width: 100%; height: {% if height %}{{ height }}{% else %}400{% endif %}px;"></div>

<script>

    function Marker(map, position, icon, content) {
        var self = this;
        self.marker = new google.maps.Marker({
            map: map,
            position: position,
            icon: icon
        });
        if (content) {
            self.info_window = new google.maps.InfoWindow({
                content: content
            });
            self.closed = true;
            google.maps.event.addListener(self.info_window, 'closeclick', function () {
                self.closed = true;
            });
            google.maps.event.addListener(self.marker, 'mouseover', function () {
                self.info_window.open(map, self.marker);
            });
            google.maps.event.addListener(self.marker, 'mouseout', function () {
                if (self.closed) {
                    self.info_window.close(map, self.marker);
                }
            });
            google.maps.event.addListener(self.marker, 'click', function () {
                if (self.closed) {
                    self.info_window.open(map, self.marker);
                    self.closed = false;
                }
            });
        }
    }

    function init_map() {

        var map = new google.maps.Map(document.getElementById("map-container"), {
            {% if zoom %}
                zoom: {{ zoom }},
            {% elif default_coordinates %}
                zoom: {{ default_coordinates.zoom }},
            {% else %}
                zoom: 13,
            {% endif %}

            {% if latitude  and longitude %}
                center: new google.maps.LatLng({{ latitude }}, {{ longitude }}),
            {% elif default_coordinates %}
                center: new google.maps.LatLng({{ default_coordinates.lat }}, {{ default_coordinates.lng }}),
                {#            {% else %}#}
                {#                center: new google.maps.LatLng(3.130563, 101.626977),#}
            {% endif %}
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        {% for location in locations %}

            var position = new google.maps.LatLng({{ location.latitude }}, {{ location.longitude }});

            var icon = {% if default_marker %}'{% static 'img/map/default_marker.png' %}'
                {% elif location.marker_url %}'{{ location.marker_url }}'
                {% else %}'{% static 'img/map/default_marker.png' %}'
            {% endif %};

            var content;
            {% if location.get_info_window %}
                content = '{{ location.get_info_window|safe }}';
            {% else %}
                content = '';
            {% endif %}

            new Marker(map, position, icon, content);

        {% endfor %}
    }
    google.maps.event.addDomListener(window, 'load', init_map);

</script>